---
phase: 02-core-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - src/workspace/types.ts
  - src/workspace/paths.ts
  - src/workspace/validate.ts
  - src/workspace/ConversationStore.ts
  - src/workspace/WorkspaceManager.ts
  - src/workspace/index.ts
autonomous: true

must_haves:
  truths:
    - "Workspace directory created on disk at XDG-compliant path"
    - "Messages persist to JSONL file and load back identically"
    - "Named workspace uses sanitized filesystem-safe name"
    - "Numbered workspace auto-increments from last used number"
    - "Last active workspace tracked in metadata file"
  artifacts:
    - path: "src/workspace/types.ts"
      provides: "Message, Workspace, WorkspaceMetadata types"
      contains: "interface Message"
    - path: "src/workspace/ConversationStore.ts"
      provides: "JSONL append/load for messages"
      exports: ["ConversationStore"]
    - path: "src/workspace/WorkspaceManager.ts"
      provides: "Create, load, list, switch workspaces"
      exports: ["WorkspaceManager"]
    - path: "src/workspace/paths.ts"
      provides: "XDG-compliant directory resolution"
      exports: ["getWorkspacesDir", "getWorkspacePath"]
  key_links:
    - from: "src/workspace/WorkspaceManager.ts"
      to: "src/workspace/ConversationStore.ts"
      via: "Creates ConversationStore per workspace"
      pattern: "new ConversationStore"
    - from: "src/workspace/WorkspaceManager.ts"
      to: "src/workspace/paths.ts"
      via: "Resolves workspace directories"
      pattern: "getWorkspacesDir|getWorkspacePath"
---

<objective>
Install Phase 2 dependencies, configure TSX/JSX compilation, and build the workspace backend layer (types, paths, validation, JSONL store, workspace manager).

Purpose: Everything in Phase 2 depends on shared types and workspace persistence. This plan creates the data layer that UI and streaming plans build on.
Output: Working workspace system that creates directories, persists messages as JSONL, tracks last-active workspace, and auto-increments numbered workspaces.
</objective>

<execution_context>
@/Users/enw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-interface/02-CONTEXT.md
@.planning/phases/02-core-interface/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure JSX</name>
  <files>package.json, tsconfig.json</files>
  <action>
Install all Phase 2 dependencies:
```bash
pnpm add ink react @anthropic-ai/sdk ink-text-input ink-spinner meow sanitize-filename xdg-basedir
pnpm add -D @types/react ink-testing-library
```

Update tsconfig.json to support JSX:
- Add `"jsx": "react-jsx"` to compilerOptions
- Add `"jsxImportSource": "react"` to compilerOptions (for automatic JSX runtime, no manual React imports needed)

Verify: `pnpm exec tsc --noEmit` passes (existing code still compiles).
  </action>
  <verify>
`pnpm exec tsc --noEmit` exits 0. `pnpm ls ink react @anthropic-ai/sdk` shows installed versions.
  </verify>
  <done>All Phase 2 dependencies installed. TSX compilation configured. Existing Phase 1 code still compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Shared types and utility functions</name>
  <files>src/workspace/types.ts, src/workspace/paths.ts, src/workspace/validate.ts</files>
  <action>
Create `src/workspace/types.ts`:
```typescript
export interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
  cancelled?: boolean;
}

export interface WorkspaceInfo {
  name: string;
  path: string;
  createdAt: number;
  lastActiveAt: number;
}

export interface WorkspacesMetadata {
  lastActive: string | null;       // workspace name
  lastNumbered: number;            // counter for auto-increment
}
```

Create `src/workspace/paths.ts`:
- `getDataDir()`: Returns `$XDG_DATA_HOME/vec` (fallback `~/.local/share/vec`). Use xdg-basedir.
- `getWorkspacesDir()`: Returns `{dataDir}/workspaces`
- `getWorkspacePath(name: string)`: Returns `{workspacesDir}/{name}`
- `getMetadataPath()`: Returns `{workspacesDir}/.metadata.json`

Create `src/workspace/validate.ts`:
- `validateWorkspaceName(name: string)`: Returns `{ valid: boolean; sanitized: string; error?: string }`
- Rules: alphanumeric + hyphens + underscores only, 1-100 chars, no spaces
- Use sanitize-filename for cross-platform safety, then additionally reject names with characters outside `[a-zA-Z0-9_-]`
- Return error message if invalid (e.g., "Workspace name contains invalid characters. Use alphanumeric, hyphens, underscores only.")
  </action>
  <verify>
`pnpm exec tsc --noEmit` passes. Types importable from workspace/types.ts.
  </verify>
  <done>Message, WorkspaceInfo, WorkspacesMetadata types defined. Path resolution and name validation utilities working.</done>
</task>

<task type="auto">
  <name>Task 3: ConversationStore and WorkspaceManager</name>
  <files>src/workspace/ConversationStore.ts, src/workspace/WorkspaceManager.ts, src/workspace/index.ts</files>
  <action>
Create `src/workspace/ConversationStore.ts`:
- Constructor takes workspace path
- `append(message: Message): Promise<void>` -- appends JSON line to `conversation.jsonl`
- `loadAll(): Promise<Message[]>` -- reads all lines, parses JSON, returns Message array. Returns empty array if file doesn't exist (ENOENT).
- `clear(): Promise<void>` -- deletes conversation.jsonl if exists
- File path: `{workspacePath}/conversation.jsonl`
- Use `fs/promises` (appendFile, readFile, unlink)

Create `src/workspace/WorkspaceManager.ts`:
- Constructor takes optional `{ dataDir?: string }` for testability (defaults to getDataDir())
- `async ensureDirectories(): Promise<void>` -- creates workspaces dir if missing
- `async create(name: string): Promise<WorkspaceInfo>` -- validates name, creates directory, returns info. Throws if name invalid.
- `async createNumbered(): Promise<WorkspaceInfo>` -- reads metadata, increments lastNumbered, creates workspace named `workspace-{N}`, updates metadata
- `async load(name: string): Promise<{ info: WorkspaceInfo; store: ConversationStore }>` -- loads existing workspace, returns info + store. Throws if doesn't exist.
- `async getOrCreate(name: string): Promise<{ info: WorkspaceInfo; store: ConversationStore }>` -- creates if not exists, loads if exists. Updates lastActive in metadata.
- `async getLastActive(): Promise<string | null>` -- reads metadata, returns lastActive workspace name
- `async setLastActive(name: string): Promise<void>` -- writes lastActive to metadata
- `async list(): Promise<WorkspaceInfo[]>` -- lists workspace directories, returns info for each
- Metadata stored as `.metadata.json` in workspaces dir (use getMetadataPath())
- All metadata reads/writes: read JSON, modify, write JSON (no partial updates)

Create `src/workspace/index.ts` barrel export:
- Export all types from types.ts
- Export ConversationStore, WorkspaceManager
- Export path utilities and validation
  </action>
  <verify>
`pnpm exec tsc --noEmit` passes. Write a quick verification: create WorkspaceManager with temp dir, create workspace, append message, load messages, verify round-trip.
  </verify>
  <done>WorkspaceManager creates/loads/lists workspaces. ConversationStore appends/loads JSONL messages. Numbered workspaces auto-increment. Last-active workspace tracked in metadata.</done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit` -- zero errors
- `pnpm vitest run` -- existing Phase 1 tests still pass
- Workspace types correctly defined with all required fields
- ConversationStore round-trips messages through JSONL
- WorkspaceManager creates directories at XDG-compliant paths
</verification>

<success_criteria>
- All Phase 2 dependencies installed and importable
- TSX/JSX compilation configured
- Workspace backend fully functional: create, load, list, numbered, last-active
- JSONL persistence working with append-only pattern
- Existing Phase 1 code and tests unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-interface/02-01-SUMMARY.md`
</output>
