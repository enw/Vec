---
phase: 02-core-interface
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/ui/hooks/useConversation.ts
  - src/ui/hooks/useStreaming.ts
  - src/cli/app.tsx
autonomous: false

must_haves:
  truths:
    - "User sends message and receives streaming response from Anthropic API"
    - "Ctrl+C during streaming cancels response, marks as [cancelled], allows new input"
    - "Messages persist across restart -- stop vec, restart, see previous messages"
    - "Token usage from each response is tracked via SecurityManager"
    - "User can create named workspace with -w flag and resume it later"
  artifacts:
    - path: "src/ui/hooks/useConversation.ts"
      provides: "Conversation state with persistence"
      exports: ["useConversation"]
    - path: "src/ui/hooks/useStreaming.ts"
      provides: "Streaming state with cancellation"
      exports: ["useStreaming"]
    - path: "src/cli/app.tsx"
      provides: "Fully wired App with real streaming"
      exports: ["App"]
  key_links:
    - from: "src/ui/hooks/useStreaming.ts"
      to: "src/llm/AnthropicClient.ts"
      via: "Calls client.stream() with onChunk updating React state"
      pattern: "client\\.stream"
    - from: "src/ui/hooks/useConversation.ts"
      to: "src/workspace/ConversationStore.ts"
      via: "Persists messages via store.append()"
      pattern: "store\\.append"
    - from: "src/cli/app.tsx"
      to: "src/ui/hooks/useStreaming.ts"
      via: "Wires streaming to conversation flow"
      pattern: "useStreaming"
    - from: "src/cli/app.tsx"
      to: "src/security.ts"
      via: "Token usage tracking"
      pattern: "trackTokens|SecurityManager"
---

<objective>
Wire streaming and persistence hooks into the App, replacing placeholder responses with real Anthropic streaming. Add Ctrl+C cancellation, token tracking, and session persistence.

Purpose: This is the plan that makes the conversation actually work. After this, users can talk to the assistant and get real streaming responses.
Output: Fully functional conversational TUI with streaming, persistence, cancellation, and token tracking.
</objective>

<execution_context>
@/Users/enw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-interface/02-CONTEXT.md
@.planning/phases/02-core-interface/02-RESEARCH.md
@.planning/phases/02-core-interface/02-01-SUMMARY.md
@.planning/phases/02-core-interface/02-02-SUMMARY.md
@.planning/phases/02-core-interface/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: React hooks for conversation and streaming</name>
  <files>src/ui/hooks/useConversation.ts, src/ui/hooks/useStreaming.ts</files>
  <action>
Create `src/ui/hooks/useConversation.ts`:
- Takes `{ store: ConversationStore }` parameter
- State: `messages: Message[]`, `loading: boolean`
- On mount: `store.loadAll()` -> set messages, loading = false
- `addMessage(msg: Message)`: appends to state AND `store.append(msg)`
- `updateLastMessage(content: string)`: updates last message's content in state (for building streaming response incrementally -- does NOT write to store, that happens on completion)
- Returns `{ messages, loading, addMessage, updateLastMessage }`

Create `src/ui/hooks/useStreaming.ts`:
- Takes `{ client: AnthropicClient; onComplete: (result: StreamResult) => void }` parameter
- State: `isStreaming: boolean`, `currentChunk: string` (accumulated text so far), `error: string | null`
- Holds `AbortController` ref (useRef)
- `send(messages: LLMMessage[])`: creates new AbortController, calls `client.stream({ messages, onChunk: (text) => setCurrentChunk(prev => prev + text), signal: controller.signal })`. On resolve: call onComplete with result, reset state.
- `cancel()`: calls `controller.abort()`. After stream resolves with cancelled=true, call onComplete.
- Returns `{ isStreaming, currentChunk, error, send, cancel }`

Both hooks use React useState/useEffect/useRef/useCallback. Import from 'react'.
  </action>
  <verify>`pnpm exec tsc --noEmit` passes. Hooks export correctly.</verify>
  <done>useConversation manages message state with JSONL persistence. useStreaming wraps AnthropicClient with React state and cancellation.</done>
</task>

<task type="auto">
  <name>Task 2: Wire hooks into App with Ctrl+C and token tracking</name>
  <files>src/cli/app.tsx</files>
  <action>
Update `src/cli/app.tsx` to replace placeholder logic with real streaming:

1. **Instantiate services on mount:**
   - Create ConversationStore for workspacePath
   - Create AnthropicClient (no args, reads ANTHROPIC_API_KEY from env)
   - Optionally initialize SecurityManager for token tracking (try/catch -- if config missing, skip token tracking with console.warn)

2. **Use hooks:**
   - `useConversation({ store })` -- for messages + persistence
   - `useStreaming({ client, onComplete })` -- for streaming state

3. **onSubmit flow:**
   - Create user Message, call `addMessage(user msg)`
   - Build LLMMessage[] array from conversation.messages (map Message -> LLMMessage)
   - Call `streaming.send(llmMessages)`

4. **onComplete callback:**
   - Create assistant Message from StreamResult (content, cancelled flag)
   - Call `addMessage(assistant msg)` -- persists to JSONL
   - If result.usage and SecurityManager available: call `security.trackTokens(result.usage)`
   - If result.error: create assistant Message with error content in red

5. **Ctrl+C handling:**
   - Use Ink's `useInput` hook: if `key.ctrl && input === 'c'` AND streaming.isStreaming, call `streaming.cancel()`
   - If NOT streaming on Ctrl+C, call Ink's `exit()` to quit app
   - This gives double-Ctrl+C behavior: first cancels stream, second exits app

6. **Pass state to components:**
   - `<StatusBar workspaceName={workspaceName} mode={mode} isStreaming={streaming.isStreaming} />`
   - `<ConversationView messages={conversation.messages} streamingContent={streaming.isStreaming ? streaming.currentChunk : undefined} />`
   - `<InputPrompt onSubmit={onSubmit} disabled={streaming.isStreaming} />`

7. **Error state:**
   - If ANTHROPIC_API_KEY not set, show error message in ConversationView area: "Set ANTHROPIC_API_KEY environment variable to start chatting."
   - Check on mount: `if (!process.env.ANTHROPIC_API_KEY)` set error state

Remove the placeholder 500ms timeout logic from Plan 02.
  </action>
  <verify>
`pnpm exec tsc --noEmit` passes. `pnpm build` succeeds.
Test manually:
1. `ANTHROPIC_API_KEY=your-key node dist/cli/index.js -w test`
2. Type "Hello" and press Enter
3. Should see streaming response appear
4. Ctrl+C during streaming should cancel and show [cancelled]
5. Exit with Ctrl+C when not streaming
6. Restart: `node dist/cli/index.js -w test` -- should see previous messages
  </verify>
  <done>App fully wired: streaming responses, Ctrl+C cancellation, message persistence, token tracking.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete CLI/TUI conversation interface with:
- Streaming Anthropic responses
- Workspace persistence (JSONL)
- Named/numbered workspace creation via -w flag
- Ctrl+C cancellation of streaming
- Session resume (messages persist across restarts)
- Token usage tracking via SecurityManager
  </what-built>
  <how-to-verify>
1. Build: `pnpm build`
2. Start with named workspace: `ANTHROPIC_API_KEY=your-key node dist/cli/index.js -w demo`
3. Verify: TUI launches with status bar showing "demo" workspace
4. Type "What is 2+2?" and press Enter
5. Verify: Streaming response appears incrementally (not all at once)
6. Verify: Timestamp visible on messages
7. Type another message, start receiving response, press Ctrl+C
8. Verify: Response shows [cancelled] marker, can type new message
9. Press Ctrl+C (not streaming) to exit
10. Restart: `ANTHROPIC_API_KEY=your-key node dist/cli/index.js -w demo`
11. Verify: Previous messages visible (including cancelled one)
12. Test numbered workspace: `node dist/cli/index.js -w` (no name)
13. Verify: Creates workspace-1 (or next number)
14. Test default resume: `node dist/cli/index.js` (no -w flag)
15. Verify: Resumes last active workspace
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `pnpm build` succeeds
- `pnpm vitest run` -- existing Phase 1 tests pass
- Manual test: full conversation flow with streaming
- Ctrl+C cancels streaming response
- Messages survive restart
- Named and numbered workspaces work
- Token usage tracked (check via SecurityManager logs)
</verification>

<success_criteria>
- CORE-01: User sees conversation interface (TUI with status bar, messages, input)
- CORE-02: User sends messages and receives streaming responses
- CORE-03: Single agent conversation works end-to-end
- CORE-04: Stop and restart preserves conversation history
- CORE-05: Named workspaces via `-w name`, numbered via `-w`, resume via no flag
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-interface/02-04-SUMMARY.md`
</output>
