---
phase: 03-memory-system
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/cli/index.tsx
  - src/cli/app.tsx
  - src/workspace/WorkspaceManager.ts
  - src/memory/recovery.ts
autonomous: true

must_haves:
  truths:
    - "All 5 profiles created on first workspace launch"
    - "SOUL.md personality loads as system prompt for LLM calls"
    - "Corrupted profiles are detected and repaired/recreated on startup"
    - "Global profiles shared across all workspaces"
  artifacts:
    - path: "src/memory/recovery.ts"
      provides: "Corruption detection and repair for profiles and conversation files"
      exports: ["validateAndRepairWorkspace"]
    - path: "src/cli/app.tsx"
      provides: "App component wired with profile loading and system prompt"
      contains: "systemPrompt"
  key_links:
    - from: "src/workspace/WorkspaceManager.ts"
      to: "src/memory/ProfileManager.ts"
      via: "ensureAllProfiles on workspace load/create"
      pattern: "ensureAllProfiles"
    - from: "src/cli/app.tsx"
      to: "src/memory/ProfileManager.ts"
      via: "load SOUL.md for system prompt"
      pattern: "loadProfile.*soul"
---

<objective>
Wire profiles into the app lifecycle: create on first launch, load SOUL.md as system prompt, validate/repair on startup. This makes profiles a living part of every conversation.

Purpose: Without wiring, profiles are dead files. This plan makes SOUL.md shape every response and ensures crash recovery works.
Output: Profile creation on first launch, SOUL.md as system prompt, recovery validation on startup.
</objective>

<execution_context>
@/Users/enw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-system/03-CONTEXT.md
@.planning/phases/03-memory-system/03-01-SUMMARY.md
@src/cli/app.tsx
@src/cli/index.tsx
@src/workspace/WorkspaceManager.ts
@src/workspace/ConversationStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Recovery validation and profile creation on startup</name>
  <files>
    src/memory/recovery.ts
    src/workspace/WorkspaceManager.ts
  </files>
  <action>
    1. Create `src/memory/recovery.ts`:

       `async function validateAndRepairWorkspace(workspacePath: string, profileManager: ProfileManager): Promise<{ repaired: string[] }>`
       - For each expected profile in the workspace, call profileManager.validateProfile()
       - If invalid: attempt to re-parse with gray-matter. If YAML is malformed, recreate from template using profileManager.ensureProfile() (which copies template if missing)
       - For conversation.jsonl: read line-by-line, try JSON.parse each line. Count corrupted lines. Log warning for each skipped line. Do NOT delete valid lines.
       - Return list of repaired files for logging

       `async function validateGlobalProfiles(profileManager: ProfileManager): Promise<{ repaired: string[] }>`
       - Same validation for USER.md and IDENTITY.md in global dir

    2. Extend `WorkspaceManager.load()`:
       - After loading workspace info, create ProfileManager instance
       - Call `profileManager.ensureAllProfiles(name)` to create any missing profiles
       - Call `validateAndRepairWorkspace(workspacePath, profileManager)` for recovery
       - Log any repaired files
       - Return profileManager alongside info and store: `{ info, store, profileManager }`

    3. Similarly extend `WorkspaceManager.getOrCreate()` to call ensureAllProfiles after create.

    4. Update `WorkspaceManager.create()` to also ensure workspace-specific profiles exist after mkdir.

    Note: This changes WorkspaceManager's return type. Update the type to include profileManager.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Test: create new workspace -> all 5 profile files exist at correct paths
    - Test: corrupt a profile's YAML -> load workspace -> profile repaired from template
    - Test: corrupt a JSONL line -> load -> valid messages still load, warning logged
  </verify>
  <done>Workspaces auto-create all profiles on first launch, corrupted files detected and repaired on startup</done>
</task>

<task type="auto">
  <name>Task 2: Wire SOUL.md as system prompt and update App</name>
  <files>
    src/cli/app.tsx
    src/cli/index.tsx
  </files>
  <action>
    1. Update `src/cli/index.tsx`:
       - Import ProfileManager
       - After workspace resolution, create ProfileManager
       - Call profileManager.ensureAllProfiles(workspaceName)
       - Call validateGlobalProfiles(profileManager) and validateAndRepairWorkspace(workspacePath, profileManager)
       - Pass profileManager to App component as prop

    2. Update `src/cli/app.tsx`:
       - Add profileManager to AppProps
       - On mount (useEffect), load SOUL.md profile via profileManager.loadProfile('soul', workspaceName)
       - Build system prompt from SOUL.md:
         ```
         You are an AI assistant.
         Personality: {soul.personality}
         Communication style: {soul.communication_style}
         Key behaviors: {soul.behavior_traits.join(', ')}

         {soul.content (markdown body)}
         ```
       - Also load USER.md (global) and include user preferences in system prompt if populated
       - Store systemPrompt in useState, pass to streaming.send() calls
       - Update handleSubmit to include systemPrompt in LLM messages

    3. Update the streaming.send() call in handleSubmit:
       - Currently builds llmMessages and calls streaming.send(llmMessages)
       - Add systemPrompt parameter: streaming.send(llmMessages, { systemPrompt })
       - This requires updating useStreaming to accept and forward systemPrompt to client.stream()

    4. Update useStreaming hook to accept optional systemPrompt in send():
       - `send(messages: LLMMessage[], options?: { systemPrompt?: string })`
       - Forward systemPrompt to client.stream({ ...options, systemPrompt })
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `pnpm build` succeeds
    - Start vec -> SOUL.md personality appears in system prompt (verify via debug log or by observing assistant behavior matches SOUL.md traits)
  </verify>
  <done>SOUL.md personality shapes every LLM response. USER.md preferences included. System prompt built from profiles on each session start.</done>
</task>

</tasks>

<verification>
- New workspace: all 5 profile files created automatically
- Existing workspace: profiles validated on load, corrupted ones repaired
- SOUL.md frontmatter used as system prompt in LLM calls
- Global profiles (USER.md, IDENTITY.md) accessible from any workspace
- `pnpm build` succeeds
</verification>

<success_criteria>
- First launch creates all profiles from templates (MEM-02, MEM-03, MEM-04, MEM-05, MEM-06)
- SOUL.md drives assistant personality per workspace
- Crash recovery validates and repairs profiles (MEM-08)
- All memory written to disk explicitly (MEM-07)
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-system/03-03-SUMMARY.md`
</output>
