---
phase: 03-memory-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/memory/profiles/schemas.ts
  - src/memory/profiles/templates/SOUL.md
  - src/memory/profiles/templates/AGENTS.md
  - src/memory/profiles/templates/USER.md
  - src/memory/profiles/templates/IDENTITY.md
  - src/memory/profiles/templates/HEARTBEAT.md
  - src/memory/ProfileManager.ts
  - src/memory/index.ts
  - src/workspace/paths.ts
autonomous: true

must_haves:
  truths:
    - "Profile schemas validate YAML frontmatter with version field"
    - "ProfileManager reads/writes profiles with atomic writes and file locking"
    - "Global profiles (USER.md, IDENTITY.md) resolve to XDG data dir root"
    - "Per-workspace profiles (SOUL.md, AGENTS.md, HEARTBEAT.md) resolve to workspace dir"
  artifacts:
    - path: "src/memory/profiles/schemas.ts"
      provides: "Zod schemas for all 5 profile types with schema:v1 versioning"
      exports: ["SoulProfileSchema", "AgentsProfileSchema", "UserProfileSchema", "IdentityProfileSchema", "HeartbeatProfileSchema"]
    - path: "src/memory/ProfileManager.ts"
      provides: "Load/save/create profiles with locking and atomic writes"
      exports: ["ProfileManager"]
    - path: "src/memory/profiles/templates/SOUL.md"
      provides: "Default SOUL.md template with YAML frontmatter"
      contains: "schema: v1"
  key_links:
    - from: "src/memory/ProfileManager.ts"
      to: "src/memory/profiles/schemas.ts"
      via: "import schemas for validation"
      pattern: "import.*schemas"
    - from: "src/memory/ProfileManager.ts"
      to: "src/workspace/paths.ts"
      via: "path resolution for global vs workspace profiles"
      pattern: "getDataDir|getWorkspacePath"
---

<objective>
Create the profile system foundation: Zod schemas for all 5 profile types, default .md templates with YAML frontmatter, and ProfileManager with atomic writes + file locking.

Purpose: Profiles are the memory backbone -- SOUL.md defines personality, USER.md stores preferences, etc. This plan creates the data layer without wiring it into the app.
Output: ProfileManager class, 5 Zod schemas, 5 template files, new dependencies installed.
</objective>

<execution_context>
@/Users/enw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-memory-system/03-CONTEXT.md
@.planning/phases/03-memory-system/03-RESEARCH.md
@src/workspace/paths.ts
@src/workspace/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create profile schemas</name>
  <files>
    package.json
    src/memory/profiles/schemas.ts
    src/memory/profiles/templates/SOUL.md
    src/memory/profiles/templates/AGENTS.md
    src/memory/profiles/templates/USER.md
    src/memory/profiles/templates/IDENTITY.md
    src/memory/profiles/templates/HEARTBEAT.md
  </files>
  <action>
    1. Install dependencies: `pnpm add write-file-atomic proper-lockfile gray-matter`
       - Do NOT install BullMQ/ioredis (using Worker Threads per research recommendation)
       - Do NOT install jsonrepair yet (add when needed)

    2. Create `src/memory/profiles/schemas.ts` with Zod schemas for all 5 profiles:

       **SoulProfileSchema (per-workspace):**
       - schema: z.literal('v1')
       - personality: z.string()
       - communication_style: z.string()
       - behavior_traits: z.array(z.string())

       **AgentsProfileSchema (per-workspace):**
       - schema: z.literal('v1')
       - agents: z.array(z.object({ name: z.string(), role: z.string(), capabilities: z.array(z.string()) }))

       **UserProfileSchema (global):**
       - schema: z.literal('v1')
       - technical: z.object({ languages: z.array(z.string()), tools: z.array(z.string()), patterns: z.array(z.string()) })
       - work_style: z.object({ communication: z.string(), explanation_depth: z.string() })

       **IdentityProfileSchema (global):**
       - schema: z.literal('v1')
       - name: z.string()
       - context: z.string()

       **HeartbeatProfileSchema (per-workspace):**
       - schema: z.literal('v1')
       - status: z.enum(['idle', 'active', 'completed'])
       - current_task: z.string().optional()
       - started_at: z.string().optional()
       - last_checkin: z.string().optional()

       Export a `ProfileType` union type: 'soul' | 'agents' | 'user' | 'identity' | 'heartbeat'
       Export a `PROFILE_SCOPE` constant mapping each ProfileType to 'global' | 'workspace'
       Export a `PROFILE_FILENAME` constant mapping each ProfileType to its filename (e.g., 'soul' -> 'SOUL.md')

    3. Create 5 template .md files in `src/memory/profiles/templates/` as actual .md files (not embedded in code, per user decision). Each template uses YAML frontmatter (gray-matter format):

       **SOUL.md template:**
       ```
       ---
       schema: v1
       personality: Helpful and concise
       communication_style: Direct, action-focused
       behavior_traits:
         - Asks before making major changes
         - Security-conscious
         - Prefers brevity
       ---
       # Assistant Personality
       Workspace-specific assistant configuration.
       ```

       **AGENTS.md template:**
       ```
       ---
       schema: v1
       agents:
         - name: default
           role: general-purpose assistant
           capabilities:
             - conversation
             - task-planning
       ---
       # Agent Configurations
       Define agent roles and capabilities for this workspace.
       ```

       **USER.md template:**
       ```
       ---
       schema: v1
       technical:
         languages: []
         tools: []
         patterns: []
       work_style:
         communication: adaptive
         explanation_depth: moderate
       ---
       # User Preferences
       Your technical preferences and work style.
       ```

       **IDENTITY.md template:**
       ```
       ---
       schema: v1
       name: ""
       context: ""
       ---
       # User Identity
       Your identity information for personalized interactions.
       ```

       **HEARTBEAT.md template:**
       ```
       ---
       schema: v1
       status: idle
       ---
       # Agent Status
       Current task status for this workspace.
       ```
  </action>
  <verify>
    - `pnpm ls write-file-atomic proper-lockfile gray-matter` shows all installed
    - `npx tsc --noEmit` passes with no errors on schemas.ts
    - All 5 template files exist and contain `schema: v1` in frontmatter
  </verify>
  <done>All profile schemas validate with Zod, all templates parseable by gray-matter, dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create ProfileManager with atomic writes and locking</name>
  <files>
    src/memory/ProfileManager.ts
    src/memory/index.ts
    src/workspace/paths.ts
  </files>
  <action>
    1. Extend `src/workspace/paths.ts` with:
       - `getGlobalProfilesDir()`: returns `join(getDataDir(), 'profiles')` for USER.md/IDENTITY.md
       - `getGlobalProfilePath(filename: string)`: returns path in global profiles dir
       - `getWorkspaceProfilePath(workspaceName: string, filename: string)`: returns path in workspace dir

    2. Create `src/memory/ProfileManager.ts`:

       ```typescript
       import lock from 'proper-lockfile';
       import writeFileAtomic from 'write-file-atomic';
       import matter from 'gray-matter';
       ```

       Class `ProfileManager`:
       - Constructor takes optional `{ dataDir?: string }` for testing
       - `async ensureProfile(type: ProfileType, workspaceName?: string): Promise<void>`
         - Resolves path using PROFILE_SCOPE (global -> getGlobalProfilePath, workspace -> getWorkspaceProfilePath)
         - If file doesn't exist, copies template from `src/memory/profiles/templates/` using `import.meta.url` to resolve template path
         - Uses writeFileAtomic for the copy
       - `async loadProfile<T>(type: ProfileType, workspaceName?: string): Promise<{ data: T; content: string }>`
         - Reads file, parses with gray-matter, validates with appropriate Zod schema
         - Returns parsed frontmatter data + markdown content body
         - Throws if file missing (caller should ensureProfile first)
       - `async saveProfile(type: ProfileType, data: Record<string, unknown>, content: string, workspaceName?: string): Promise<void>`
         - Acquires lock on parent dir (proper-lockfile, stale: 10000, update: 2000, retries: 5)
         - Serializes with matter.stringify(content, data)
         - Writes with writeFileAtomic
         - Releases lock in finally block
       - `async ensureAllProfiles(workspaceName: string): Promise<void>`
         - Creates all 5 profiles: global ones (USER.md, IDENTITY.md) in global dir, workspace ones (SOUL.md, AGENTS.md, HEARTBEAT.md) in workspace dir
         - Idempotent (skips if already exists)
       - `async validateProfile(type: ProfileType, workspaceName?: string): Promise<{ valid: boolean; error?: string }>`
         - Attempts to load and validate, returns result without throwing

       Important: Template resolution must use `new URL('../profiles/templates/', import.meta.url)` and `fileURLToPath` to find templates relative to source, not CWD. This works in both dev (ts) and dist (js).

    3. Create `src/memory/index.ts` barrel export:
       - Re-export ProfileManager
       - Re-export schemas, ProfileType, PROFILE_SCOPE, PROFILE_FILENAME
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Write a quick test: create ProfileManager, call ensureAllProfiles('test-ws'), verify files created at correct paths
  </verify>
  <done>ProfileManager can create, load, save, validate all 5 profile types with atomic writes and file locking. Global vs workspace path resolution works correctly.</done>
</task>

</tasks>

<verification>
- All 5 Zod schemas parse valid YAML frontmatter
- ProfileManager.ensureAllProfiles creates files at correct locations
- ProfileManager.saveProfile uses atomic writes (write-file-atomic) with locking (proper-lockfile)
- Global profiles resolve to $XDG_DATA_HOME/vec/profiles/
- Workspace profiles resolve to $XDG_DATA_HOME/vec/workspaces/{name}/
- `pnpm build` succeeds
</verification>

<success_criteria>
- Profile schemas with version field exist and validate
- Template .md files exist as actual files in repo (not embedded strings)
- ProfileManager handles all CRUD operations with atomic writes + locking
- Path resolution distinguishes global vs workspace profiles
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-memory-system/03-01-SUMMARY.md`
</output>
