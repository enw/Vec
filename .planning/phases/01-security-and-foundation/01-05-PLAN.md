---
phase: 01-security-and-foundation
plan: 05
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/monitoring/tracker.ts
  - src/monitoring/alerts.ts
  - src/monitoring/budget.ts
  - src/monitoring/index.ts
autonomous: true

must_haves:
  truths:
    - "Token usage tracked per model and aggregated to budget"
    - "Alerts fire at 50%, 70%, 80%, and 100% budget thresholds"
    - "User receives visible warning when approaching budget limit"
  artifacts:
    - path: "src/monitoring/tracker.ts"
      provides: "Token usage tracking per call"
      exports: ["TokenTracker"]
    - path: "src/monitoring/alerts.ts"
      provides: "Threshold-based alert system"
      exports: ["AlertManager"]
    - path: "src/monitoring/budget.ts"
      provides: "Budget period management and reset"
      exports: ["BudgetManager"]
  key_links:
    - from: "src/monitoring/tracker.ts"
      to: "src/monitoring/alerts.ts"
      via: "triggers alert check after each usage event"
      pattern: "alertManager\\.(check|evaluate)"
    - from: "src/monitoring/tracker.ts"
      to: "src/audit/logger.ts"
      via: "logs all token usage events"
      pattern: "monitorLogger"
    - from: "src/monitoring/budget.ts"
      to: "src/config/schema.ts"
      via: "uses TokenBudget config type"
      pattern: "TokenBudget"
---

<objective>
Implement token usage monitoring with threshold alerts (SEC-04). Tracks token consumption per LLM call, manages budgets by period, and alerts at configurable thresholds.

Purpose: Prevents runaway token costs by alerting users before budget limits are reached. The 70-80% threshold gives users time to adjust before hitting limits.
Output: TokenTracker, AlertManager, and BudgetManager for the monitoring subsystem.
</objective>

<execution_context>
@/Users/enw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-security-and-foundation/01-RESEARCH.md
@.planning/phases/01-security-and-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Budget management and alert system</name>
  <files>src/monitoring/budget.ts, src/monitoring/alerts.ts</files>
  <action>
    1. Create src/monitoring/budget.ts:
       - Import TokenBudget type from config/schema
       - `BudgetManager` class:
         - Constructor: takes TokenBudget config
         - Private state: used (number), periodStart (Date), alertedThresholds (Set<number>)
         - `record(tokens: number): void` -- add tokens to used count
         - `getUsage(): { used: number, limit: number, percentage: number, remaining: number }`
         - `isExpired(): boolean` -- check if current period has ended based on periodStart + period duration
         - `reset(): void` -- zero usage, reset periodStart, clear alertedThresholds
         - `checkAndResetIfExpired(): boolean` -- if expired, reset and return true
         - `serialize(): { used: number, periodStart: string, alertedThresholds: number[] }` -- for persistence
         - `static deserialize(data, config): BudgetManager` -- restore from persisted state
    2. Create src/monitoring/alerts.ts:
       - Import monitorLogger from audit
       - `AlertLevel` type: 'info' | 'warning' | 'critical'
       - `Alert` interface: { level: AlertLevel, threshold: number, actual: number, message: string, timestamp: string }
       - `AlertManager` class:
         - Constructor: takes thresholds array (default [0.5, 0.7, 0.8, 1.0])
         - Private: firedThresholds (Set<number>), alertCallback (optional function)
         - `setCallback(fn: (alert: Alert) => void): void` -- for UI integration
         - `evaluate(percentage: number): Alert | null`
           - Find highest threshold that percentage exceeds AND hasn't been fired
           - If found: create Alert, mark as fired, call callback if set, log via monitorLogger
           - Map thresholds to levels: < 0.7 = info, 0.7-0.89 = warning, >= 0.9 = critical
           - Return Alert or null
         - `reset(): void` -- clear firedThresholds
         - `getAlertLevel(threshold: number): AlertLevel`
  </action>
  <verify>Run `pnpm exec tsc --noEmit`</verify>
  <done>BudgetManager tracks usage with period-based reset. AlertManager fires at thresholds with escalating severity levels.</done>
</task>

<task type="auto">
  <name>Task 2: Token tracker integration</name>
  <files>src/monitoring/tracker.ts, src/monitoring/index.ts</files>
  <action>
    1. Create src/monitoring/tracker.ts:
       - Import TokenUsageEvent from types.ts
       - Import BudgetManager, AlertManager
       - Import monitorLogger, auditEvent from audit
       - Import TokenBudget type from config/schema
       - `TokenTracker` class:
         - Constructor: `{ budget: TokenBudget, onAlert?: (alert: Alert) => void }`
         - Creates BudgetManager and AlertManager internally
         - Sets alert callback if provided
         - `track(event: TokenUsageEvent): { alert: Alert | null, usage: ReturnType<BudgetManager['getUsage']> }`
           a. Check and reset budget if period expired
           b. Record tokens via BudgetManager
           c. Get current usage percentage
           d. Evaluate alerts via AlertManager
           e. Log event via monitorLogger: model, tokens, budget percentage
           f. Return alert (if any) and current usage
         - `getUsage(): { used: number, limit: number, percentage: number, remaining: number }`
         - `getHistory(): TokenUsageEvent[]` -- return last N events (configurable, default 100)
         - `reset(): void` -- reset budget and alerts
         - `serialize(): object` -- for state persistence
         - `static create(config: TokenBudget, onAlert?): TokenTracker`
       - Private: store last N events in circular buffer array
    2. Create src/monitoring/index.ts: re-export all from tracker, alerts, budget
  </action>
  <verify>Run `pnpm exec tsc --noEmit`</verify>
  <done>TokenTracker integrates budget management and alerting. Tracks per-call usage, fires threshold alerts, supports period reset and state persistence per SEC-04.</done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit` passes
- TokenTracker records usage and returns updated budget state
- Alerts fire at each threshold exactly once per period
- Budget resets when period expires
- All token events logged via monitorLogger
</verification>

<success_criteria>
- Token usage tracked per LLM call with model attribution (SEC-04)
- Budget periods: daily, weekly, monthly with automatic reset
- Alerts at 50%, 70%, 80%, 100% with escalating severity
- Alert callback enables UI integration (console warning for now)
- State serializable for persistence across sessions
- History maintained for last 100 events
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-and-foundation/01-05-SUMMARY.md`
</output>
