---
phase: 01-security-and-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/egress/patterns.ts
  - src/egress/scanner.ts
  - src/egress/filter.ts
  - src/egress/index.ts
autonomous: true

must_haves:
  truths:
    - "Outbound data scanned for credentials, API keys, and PII before transmission"
    - "High-entropy strings flagged as potential secrets"
    - "Egress filter blocks or warns when sensitive data detected"
  artifacts:
    - path: "src/egress/patterns.ts"
      provides: "Secret detection regex patterns"
      exports: ["SECRET_PATTERNS", "PII_PATTERNS"]
    - path: "src/egress/scanner.ts"
      provides: "Pattern + entropy scanning engine"
      exports: ["scanForSecrets", "hasHighEntropy"]
    - path: "src/egress/filter.ts"
      provides: "Egress gate that blocks/warns on findings"
      exports: ["EgressFilter"]
  key_links:
    - from: "src/egress/filter.ts"
      to: "src/egress/scanner.ts"
      via: "calls scanForSecrets on outbound data"
      pattern: "scanForSecrets"
    - from: "src/egress/filter.ts"
      to: "src/audit/logger.ts"
      via: "logs all egress scan results"
      pattern: "egressLogger|auditEvent"
    - from: "src/egress/filter.ts"
      to: "src/permission/engine.ts"
      via: "requests permission when secrets found"
      pattern: "PermissionEngine|check"
---

<objective>
Implement egress filtering for sensitive data (SEC-03). Scans all outbound data for credentials, API keys, PII using pattern matching and entropy analysis.

Purpose: Prevents accidental data leaks by detecting secrets and PII in outbound data before it leaves the system. Combines known secret patterns with high-entropy string detection.
Output: Scanner, pattern library, and egress filter gate.
</objective>

<execution_context>
@/Users/enw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/enw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-security-and-foundation/01-RESEARCH.md
@.planning/phases/01-security-and-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Secret and PII detection patterns</name>
  <files>src/egress/patterns.ts, src/egress/scanner.ts</files>
  <action>
    1. Create src/egress/patterns.ts:
       - Define `SecretPattern` interface: { name: string, pattern: RegExp, severity: 'critical' | 'high' | 'medium' }
       - Export `SECRET_PATTERNS: SecretPattern[]` with at minimum:
         - AWS_ACCESS_KEY: /AKIA[0-9A-Z]{16}/ (critical)
         - AWS_SECRET_KEY: /(?:aws_secret_access_key|secret_key)\s*[=:]\s*[A-Za-z0-9/+=]{40}/ (critical)
         - GITHUB_TOKEN: /gh[pousr]_[A-Za-z0-9]{36,}/ (critical)
         - GITHUB_PAT: /github_pat_[A-Za-z0-9]{22}_[A-Za-z0-9]{59}/ (critical)
         - PRIVATE_KEY: /-----BEGIN (RSA|OPENSSH|EC|DSA|PGP) PRIVATE KEY-----/ (critical)
         - JWT: /eyJ[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}\.[A-Za-z0-9_-]{10,}/ (high)
         - GENERIC_API_KEY: /(?:api[_-]?key|apikey)\s*[=:]\s*['"]?[A-Za-z0-9]{20,}['"]?/i (high)
         - GENERIC_SECRET: /(?:secret|password|passwd|pwd)\s*[=:]\s*['"]?[^\s'"]{8,}['"]?/i (high)
         - SLACK_TOKEN: /xox[baprs]-[0-9]{10,}-[A-Za-z0-9-]+/ (high)
         - STRIPE_KEY: /sk_(test|live)_[A-Za-z0-9]{24,}/ (critical)
       - Export `PII_PATTERNS: SecretPattern[]`:
         - EMAIL: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/ (medium)
         - PHONE_US: /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/ (medium)
         - SSN: /\b\d{3}-?\d{2}-?\d{4}\b/ (critical) -- with refinement to exclude obvious non-SSNs
         - IP_ADDRESS: /\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b/ (medium)
    2. Create src/egress/scanner.ts:
       - Import patterns from patterns.ts, ScanResult from types.ts
       - `hasHighEntropy(str: string, threshold = 4.5): boolean`
         - Calculate Shannon entropy of the string
         - Return true if entropy exceeds threshold AND string length > 20
       - `scanForSecrets(data: string, options?: { includePatterns?: boolean, includeEntropy?: boolean, includePII?: boolean }): ScanResult`
         - Default: all detection methods enabled
         - Pattern detection: iterate SECRET_PATTERNS, find all matches via matchAll with global flag
         - PII detection: iterate PII_PATTERNS if includePII
         - Entropy detection: split by whitespace, check each token > 20 chars for high entropy
         - For each finding: record type, line number, redacted match (first 8 chars + "...")
         - Return { hasSecrets, findings }
       - `redactMatch(match: string): string` -- show first 4 and last 4 chars, mask middle with ***
  </action>
  <verify>Run `pnpm exec tsc --noEmit`</verify>
  <done>Scanner detects known secret patterns, PII, and high-entropy strings. Findings include type, location, and redacted match.</done>
</task>

<task type="auto">
  <name>Task 2: Egress filter gate</name>
  <files>src/egress/filter.ts, src/egress/index.ts</files>
  <action>
    1. Create src/egress/filter.ts:
       - Import scanForSecrets from scanner.ts
       - Import egressLogger, auditEvent from audit
       - Import PermissionEngine (type only -- actual instance injected)
       - `EgressFilter` class:
         - Constructor: `{ permissionEngine?: PermissionEngine, mode?: 'block' | 'warn' | 'log-only' }`
         - Default mode: 'block'
         - `async check(data: string, destination: string): Promise<{ allowed: boolean, findings: ScanResult['findings'] }>`
           a. Call scanForSecrets(data)
           b. If no findings: audit log "clean", return { allowed: true, findings: [] }
           c. If findings:
              - mode 'log-only': audit log findings, return allowed: true
              - mode 'warn': audit log findings with warning, return allowed: true
              - mode 'block':
                - If permissionEngine provided: check('egress.network', destination) or check('egress.file', destination)
                - If no permissionEngine or denied: return allowed: false
           d. Always audit log the decision with finding count and types
         - `scanOnly(data: string): ScanResult` -- just scan, no gating logic
       - Export EgressFilter
    2. Create src/egress/index.ts: re-export all from patterns, scanner, filter
  </action>
  <verify>Run `pnpm exec tsc --noEmit`</verify>
  <done>EgressFilter scans outbound data and blocks/warns/logs based on mode. Integrates with permission engine for override capability. All decisions audit logged per SEC-03.</done>
</task>

</tasks>

<verification>
- `pnpm exec tsc --noEmit` passes
- SECRET_PATTERNS array has 10+ patterns covering major secret types
- hasHighEntropy correctly identifies random strings (entropy > 4.5)
- EgressFilter in 'block' mode prevents data with secrets from passing
- All scan results are audit logged
</verification>

<success_criteria>
- Known credential patterns detected (AWS, GitHub, Stripe, SSH keys, JWTs)
- High-entropy strings flagged as potential secrets
- PII detection (email, phone, SSN, IP)
- Three modes: block (default), warn, log-only
- Integration point for permission engine override
- All egress decisions audit-logged (SEC-03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-and-foundation/01-04-SUMMARY.md`
</output>
